From bb643a3d0cb27e5658c551c462fc7b3cf2fb8b5f Mon Sep 17 00:00:00 2001
From: "Brett T. Warden" <brett.t.warden@intel.com>
Date: Tue, 25 Sep 2018 11:38:51 -0700
Subject: [PATCH] disable zeroconf and dns_sd

---
 src/gui/CMakeLists.txt     |  4 +++-
 src/gui/gui.pro            | 12 ------------
 src/gui/src/MainWindow.cpp | 31 -------------------------------
 src/gui/src/MainWindow.h   |  5 -----
 4 files changed, 3 insertions(+), 49 deletions(-)

diff --git a/src/gui/CMakeLists.txt b/src/gui/CMakeLists.txt
index a612afc2..21e5dfc6 100644
--- a/src/gui/CMakeLists.txt
+++ b/src/gui/CMakeLists.txt
@@ -11,6 +11,9 @@ file (GLOB LEGACY_GUI_UI_FILES src/*.ui)
 file (GLOB LEGACY_ACTIVATION_FILES src/*Activation* src/*License*)
 file (GLOB LEGACY_ZEROCONF_FILES src/Zeroconf*)
 
+# Disable Zeroconf
+list (REMOVE_ITEM LEGACY_GUI_SOURCE_FILES ${LEGACY_ZEROCONF_FILES})
+
 if (SYNERGY_ENTERPRISE)
     list (REMOVE_ITEM LEGACY_GUI_SOURCE_FILES ${LEGACY_ACTIVATION_FILES})
     list (REMOVE_ITEM LEGACY_GUI_UI_FILES ${LEGACY_ACTIVATION_FILES})
@@ -45,7 +48,6 @@ if (WIN32)
     endif()
 
 elseif (${CMAKE_SYSTEM_NAME} MATCHES "Linux")
-    target_link_libraries (synergy dns_sd)
 endif()
 endif()
 
diff --git a/src/gui/gui.pro b/src/gui/gui.pro
index 176d6851..2731a8ed 100644
--- a/src/gui/gui.pro
+++ b/src/gui/gui.pro
@@ -51,11 +51,6 @@ SOURCES += src/main.cpp \
     src/Ipc.cpp \
     src/SynergyLocale.cpp \
     src/QUtility.cpp \
-    src/ZeroconfServer.cpp \
-    src/ZeroconfThread.cpp \
-    src/ZeroconfRegister.cpp \
-    src/ZeroconfBrowser.cpp \
-    src/ZeroconfService.cpp \
     src/DataDownloader.cpp \
     src/AddClientDialog.cpp \
     src/CommandProcess.cpp \
@@ -96,12 +91,6 @@ HEADERS += src/MainWindow.h \
     src/Ipc.h \
     src/SynergyLocale.h \
     src/QUtility.h \
-    src/ZeroconfServer.h \
-    src/ZeroconfThread.h \
-    src/ZeroconfRegister.h \
-    src/ZeroconfRecord.h \
-    src/ZeroconfBrowser.h \
-    src/ZeroconfService.h \
     src/DataDownloader.h \
     src/AddClientDialog.h \
     src/CommandProcess.h \
@@ -128,7 +117,6 @@ macx {
     QMAKE_BUNDLE_DATA += QSYNERGY_ICON
     LIBS += $$MACX_LIBS
 }
-unix:!macx:LIBS += -ldns_sd
 debug { 
     OBJECTS_DIR = tmp/debug
     MOC_DIR = tmp/debug
diff --git a/src/gui/src/MainWindow.cpp b/src/gui/src/MainWindow.cpp
index 624d71ba..899cf76e 100644
--- a/src/gui/src/MainWindow.cpp
+++ b/src/gui/src/MainWindow.cpp
@@ -34,7 +34,6 @@
 #include "QUtility.h"
 #include "ProcessorArch.h"
 #include "SslCertificate.h"
-#include "Zeroconf.h"
 
 #include <QtCore>
 #include <QtGui>
@@ -83,7 +82,6 @@ MainWindow::MainWindow (QSettings& settings, AppConfig& appConfig,
     m_LicenseManager(&licenseManager),
     m_ActivationDialogRunning(false),
 #endif
-    m_pZeroconf(nullptr),
     m_Settings(settings),
     m_AppConfig(&appConfig),
     m_pSynergy(NULL),
@@ -103,9 +101,6 @@ MainWindow::MainWindow (QSettings& settings, AppConfig& appConfig,
     m_pSslCertificate(NULL),
     m_SecureSocket(false)
 {
-#ifndef SYNERGY_ENTERPRISE
-    m_pZeroconf = new Zeroconf(this);
-#endif
 
     setupUi(this);
 
@@ -178,7 +173,6 @@ MainWindow::MainWindow (QSettings& settings, AppConfig& appConfig,
 #endif
 
 #ifndef SYNERGY_ENTERPRISE
-    updateZeroconfService();
     updateAutoConfigWidgets();
 #endif
 }
@@ -190,10 +184,6 @@ MainWindow::~MainWindow()
         stopDesktop();
     }
 
-#ifndef SYNERGY_ENTERPRISE
-    delete m_pZeroconf;
-#endif
-
     saveSettings();
 
     delete m_pSslCertificate;
@@ -1185,7 +1175,6 @@ void MainWindow::on_m_pGroupClient_toggled(bool on)
 
     // only call in either client or server toggle, but not both
     // since the toggle functions call eachother indirectly.
-    updateZeroconfService();
 }
 
 void MainWindow::on_m_pGroupServer_toggled(bool on)
@@ -1225,25 +1214,6 @@ void MainWindow::on_m_pActionAbout_triggered()
     dlg.exec();
 }
 
-void MainWindow::updateZeroconfService()
-{
-#ifndef SYNERGY_ENTERPRISE
-
-    // reset the server list in case one has gone away.
-    // it'll be re-added after the zeroconf service restarts.
-    m_pComboServerList->clear();
-
-    if (m_pZeroconf != nullptr) {
-        if (appConfig().autoConfig()) {
-            m_pZeroconf->startService();
-        }
-        else {
-            m_pZeroconf->stopService();
-        }
-    }
-#endif
-}
-
 void MainWindow::updateAutoConfigWidgets()
 {
     if (appConfig().autoConfig()) {
@@ -1281,7 +1251,6 @@ void MainWindow::on_m_pActionSettings_triggered()
 
     if (lastAutoConfig != appConfig().autoConfig()) {
         updateAutoConfigWidgets();
-        updateZeroconfService();
     }
 }
 
diff --git a/src/gui/src/MainWindow.h b/src/gui/src/MainWindow.h
index e267ccf2..16dda33d 100644
--- a/src/gui/src/MainWindow.h
+++ b/src/gui/src/MainWindow.h
@@ -56,7 +56,6 @@ class DataDownloader;
 class CommandProcess;
 class SslCertificate;
 class LicenseManager;
-class Zeroconf;
 
 class MainWindow : public QMainWindow, public Ui::MainWindowBase
 {
@@ -119,14 +118,11 @@ class MainWindow : public QMainWindow, public Ui::MainWindowBase
         void autoAddScreen(const QString name);
         void zeroconfServerDetected(const QString name);
         void updateLocalFingerprint();
-        Zeroconf& zeroconf() { return *m_pZeroconf; }
 #ifndef SYNERGY_ENTERPRISE
         LicenseManager& licenseManager() const;
         int raiseActivationDialog();
 #endif
 
-        void updateZeroconfService();
-
 public slots:
         void setEdition(Edition edition);
 #ifndef SYNERGY_ENTERPRISE
@@ -208,7 +204,6 @@ public slots:
         bool m_ActivationDialogRunning;
         QStringList m_PendingClientNames;
 #endif
-        Zeroconf* m_pZeroconf;
         QSettings& m_Settings;
         AppConfig* m_AppConfig;
         QProcess* m_pSynergy;
-- 
2.19.0

